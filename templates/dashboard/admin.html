{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="text-center mb-4">
        <div class="logo-container">
            <img src="{{ url_for('static', filename='images/CA Logo No Background.png') }}" alt="Clinician Assist Logo" class="ca-logo dashboard-logo">
        </div>
    </div>

    <div class="row">
        <!-- Left Column - Chat Interface -->
        <div class="col-md-6 mb-4 mb-md-0">
            <div class="card chat-card h-100">
                <div class="card-body">
                    <h5 class="card-title dashboard-subtitle">Admin Chat</h5>
                    
                    <!-- Tabs -->
                    <ul class="nav nav-tabs mb-3" id="chatTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="voice-tab" data-bs-toggle="tab" data-bs-target="#voice-chat" type="button" role="tab" aria-controls="voice-chat" aria-selected="true">
                                <i class="bi bi-mic"></i> Voice Chat
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="text-tab" data-bs-toggle="tab" data-bs-target="#text-chat" type="button" role="tab" aria-controls="text-chat" aria-selected="false">
                                <i class="bi bi-chat-text"></i> Text Chat
                            </button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content" id="chatTabsContent">
                        <!-- Voice Chat Tab -->
                        <div class="tab-pane fade show active" id="voice-chat" role="tabpanel" aria-labelledby="voice-tab">
                            <div class="voice-chat-container">
                                <div class="voice-controls text-center mb-4">
                                    <div class="record-button-container">
                                        <button id="recordButton" class="btn btn-lg btn-record">
                                            <i class="bi bi-mic"></i>
                                        </button>
                                        <div class="record-text">Press and Hold to Speak</div>
                                    </div>
                                </div>
                                
                                <div class="voice-messages" id="voice-messages">
                                    <!-- Voice messages will be added here dynamically -->
                                </div>
                            </div>
                        </div>

                        <!-- Text Chat Tab -->
                        <div class="tab-pane fade" id="text-chat" role="tabpanel" aria-labelledby="text-tab">
                            <div class="chat-messages" id="chat-messages">
                                {% for message in messages %}
                                <div class="message {% if message.is_ai_response %}ai-message{% else %}user-message{% endif %} message-appear">
                                    <div class="message-content">{{ message.content }}</div>
                                    <div class="message-timestamp">{{ message.timestamp.strftime('%I:%M %p') }}</div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="typing-indicator" id="typing-indicator" style="display: none;">
                                <span class="dot"></span>
                                <span class="dot"></span>
                                <span class="dot"></span>
                            </div>
                            <div class="chat-input-form">
                                <form id="chat-form" class="chat-form">
                                    <div class="input-group">
                                        <input type="text" id="message-input" class="form-control" placeholder="Type your message..." required>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-send"></i>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Chat Monitoring -->
        <div class="col-md-6">
            <div class="card chat-monitoring-card">
                <div class="card-body">
                    <h5 class="card-title dashboard-subtitle">Chat Monitoring</h5>
                    
                    <!-- Filters -->
                    <div class="row mb-3">
                        <div class="col-md-6 mb-2">
                            <select id="userFilter" class="form-select">
                                <option value="">All Users</option>
                                {% for user in users %}
                                <option value="{{ user.id }}">{{ user.email }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-2">
                            <select id="messageTypeFilter" class="form-select">
                                <option value="">All Types</option>
                                <option value="text">Text Messages</option>
                                <option value="voice">Voice Messages</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-2">
                            <select id="flaggedFilter" class="form-select">
                                <option value="">All Messages</option>
                                <option value="true">Flagged Only</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-2">
                            <button id="refreshChat" class="btn btn-primary w-100">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Chat Messages -->
                    <div class="chat-monitoring-messages" id="monitoringMessages">
                        <!-- Messages will be loaded here dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Message Details Modal -->
<div class="modal fade" id="messageDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Message Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="message-details"></div>
                <div class="form-group mt-3">
                    <label for="monitorNotes">Monitoring Notes:</label>
                    <textarea id="monitorNotes" class="form-control" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" id="flagMessage">
                    <i class="bi bi-flag"></i> Flag Message
                </button>
                <button type="button" class="btn btn-primary" id="saveNotes">Save Notes</button>
            </div>
        </div>
    </div>
</div>

<!-- Socket.IO client -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<!-- Add voice recording script -->
<script src="{{ url_for('static', filename='js/voice-chat.js') }}"></script>

<!-- Chat and monitoring scripts -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Socket.IO connection with error handling and reconnection logic
    const socket = io({
        reconnection: true,
        reconnectionAttempts: 5,
        reconnectionDelay: 1000,
        reconnectionDelayMax: 5000,
        timeout: 20000
    });
    
    // Chat interface elements
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const typingIndicator = document.getElementById('typing-indicator');
    
    // Monitoring elements
    const monitoringMessages = document.getElementById('monitoringMessages');
    const userFilter = document.getElementById('userFilter');
    const messageTypeFilter = document.getElementById('messageTypeFilter');
    const flaggedFilter = document.getElementById('flaggedFilter');
    const refreshButton = document.getElementById('refreshChat');

    // Connection status handling
    socket.on('connect', () => {
        console.log('Connected to server');
    });

    socket.on('disconnect', () => {
        console.log('Disconnected from server');
    });

    socket.on('error', (error) => {
        console.error('Socket error:', error);
    });

    // Format timestamp
    function formatTimestamp(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleString();
    }

    // Add new message to chat
    function addMessage(content, timestamp, isAI) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isAI ? 'ai-message' : 'user-message'} message-appear`;
        
        messageDiv.innerHTML = `
            <div class="message-content">${content}</div>
            <div class="message-timestamp">${formatTimestamp(timestamp)}</div>
        `;
        
        chatMessages.appendChild(messageDiv); // Changed to appendChild to maintain chronological order
        chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll to latest message
    }

    // Add new message to monitoring view
    function addMonitoringMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'monitoring-message';
        messageDiv.dataset.messageId = message.id;
        
        let content = message.message_type === 'voice' 
            ? `<audio controls src="${message.voice_url}" class="w-100"></audio>`
            : `<div class="message-text">${message.content}</div>`;

        messageDiv.innerHTML = `
            <div class="message-header">
                <span class="user-email">${message.user_email}</span>
                <span class="message-type badge bg-info">${message.message_type}</span>
                <span class="timestamp">${formatTimestamp(message.timestamp)}</span>
                ${message.flagged ? '<span class="badge bg-warning ms-2">Flagged</span>' : ''}
            </div>
            <div class="message-content">${content}</div>
            <div class="message-footer">
                <button class="btn btn-sm btn-primary view-details" data-message-id="${message.id}">
                    <i class="bi bi-eye"></i> View Details
                </button>
            </div>
        `;
        
        monitoringMessages.insertBefore(messageDiv, monitoringMessages.firstChild);
    }

    // Handle chat form submission
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (message) {
            socket.emit('admin_send_message', { message: message });
            messageInput.value = '';
            messageInput.focus();
        }
    });

    // Load monitoring messages with current filters
    function loadMessages() {
        const filters = {
            user_id: userFilter.value,
            message_type: messageTypeFilter.value,
            flagged: flaggedFilter.value
        };
        
        socket.emit('admin_get_messages', filters);
    }

    // Event listeners for filters
    userFilter.addEventListener('change', loadMessages);
    messageTypeFilter.addEventListener('change', loadMessages);
    flaggedFilter.addEventListener('change', loadMessages);
    refreshButton.addEventListener('click', loadMessages);

    // Socket event handlers for chat
    socket.on('new_message', function(data) {
        addMessage(data.content, data.timestamp, data.is_ai_response);
    });

    socket.on('typing_indicator', function(data) {
        typingIndicator.style.display = data.typing ? 'block' : 'none';
    });

    // Socket event handlers for monitoring
    socket.on('admin_messages', function(data) {
        monitoringMessages.innerHTML = '';
        data.messages.forEach(addMonitoringMessage);
    });

    socket.on('new_monitored_message', function(message) {
        addMonitoringMessage(message);
    });

    // Handle message details view
    monitoringMessages.addEventListener('click', function(e) {
        if (e.target.closest('.view-details')) {
            const messageId = e.target.closest('.view-details').dataset.messageId;
            socket.emit('admin_get_message_details', { message_id: messageId });
        }
    });

    // Handle message details response
    socket.on('admin_message_details', function(details) {
        const modal = new bootstrap.Modal(document.getElementById('messageDetailsModal'));
        const detailsDiv = document.querySelector('.message-details');
        const notesTextarea = document.getElementById('monitorNotes');
        const flagButton = document.getElementById('flagMessage');
        const saveButton = document.getElementById('saveNotes');

        detailsDiv.innerHTML = `
            <p><strong>User:</strong> ${details.user_email}</p>
            <p><strong>Timestamp:</strong> ${formatTimestamp(details.timestamp)}</p>
            <p><strong>Type:</strong> ${details.message_type}</p>
            <div class="message-content mt-3">
                ${details.message_type === 'voice' 
                    ? `<audio controls src="${details.voice_url}" class="w-100"></audio>`
                    : `<div class="message-text">${details.content}</div>`
                }
            </div>
        `;

        notesTextarea.value = details.monitor_notes || '';
        flagButton.dataset.messageId = details.id;
        saveButton.dataset.messageId = details.id;

        modal.show();
    });

    // Handle flagging and saving notes
    document.getElementById('flagMessage').addEventListener('click', function() {
        const messageId = this.dataset.messageId;
        socket.emit('admin_flag_message', { 
            message_id: messageId,
            flagged: true
        });
    });

    document.getElementById('saveNotes').addEventListener('click', function() {
        const messageId = this.dataset.messageId;
        const notes = document.getElementById('monitorNotes').value;
        socket.emit('admin_save_notes', {
            message_id: messageId,
            notes: notes
        });
    });

    // Initial load
    loadMessages();
});
</script>

<style>
.chat-card {
    height: calc(100vh - 250px);
    margin-bottom: 0;
    display: flex;
    flex-direction: column;
}

.chat-card .card-body {
    display: flex;
    flex-direction: column;
    height: 100%;
}

.tab-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
}

.tab-pane {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100%;
}

#text-chat {
    display: flex;
    flex-direction: column;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    padding: 1rem;
    gap: 1rem;
    margin-bottom: 1rem;
}

.chat-input-form {
    position: sticky;
    bottom: 0;
    background: white;
    padding: 1rem;
    border-top: 1px solid var(--bs-border-color);
    margin-top: auto;
}

.chat-monitoring-card {
    height: calc(100vh - 250px);
    margin-bottom: 0;
}

.chat-monitoring-messages {
    height: calc(100% - 180px);
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.monitoring-message {
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 1rem;
    background-color: #fff;
    transition: transform 0.2s, box-shadow 0.2s;
}

.monitoring-message:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.message-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-bottom: 0.75rem;
}

.message-content {
    margin: 0.75rem 0;
    padding: 0.5rem;
    background-color: #f8f9fa;
    border-radius: 0.25rem;
}

.message-text {
    white-space: pre-wrap;
}

.message-footer {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
}

.typing-indicator {
    padding: 0.5rem;
    text-align: center;
    position: sticky;
    bottom: 100%;
    background: rgba(255, 255, 255, 0.9);
    z-index: 1;
}
</style>
{% endblock %}
